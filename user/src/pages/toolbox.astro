---
// üöÄ ÈùôÊÄÅÈ¢ÑÊ∏≤Êüì
export const prerender = true;

import PageLayout from "../layouts/PageLayout.astro";
import ToolCard from "../components/ToolCard.astro";
import { apiUrl } from "../lib/api";

interface Tool {
    name: string;
    description: string;
    url: string;
    icon: string;
    category: string;
}

let tools: Tool[] = [];
try {
    const response = await fetch(apiUrl("/api/user/tools"));
    if (response.ok) {
        tools = (await response.json()) as Tool[];
    } else {
        console.error(
            `Failed to fetch tools: ${response.status} ${response.statusText}`,
        );
    }
} catch (error) {
    console.error("Failed to fetch tools:", error);
}

// Group tools by category
const groupedTools = tools.reduce((acc: Record<string, Tool[]>, tool) => {
    const category = tool.category || "Other";
    if (!acc[category]) {
        acc[category] = [];
    }
    acc[category].push(tool);
    return acc;
}, {});

const categories = Object.keys(groupedTools).sort();

// ÂàÜÈ°µËæÖÂä©ÂáΩÊï∞ÔºöÂ∞ÜÂ∑•ÂÖ∑ÂàÜÊàêÊØè6‰∏™‰∏ÄÁªÑ
const chunkArray = <T,>(arr: T[], size: number): T[][] => {
    const chunks: T[][] = [];
    for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
    }
    return chunks;
};

const ITEMS_PER_PAGE = 6;

// ‰∏∫ÊØè‰∏™ÂàÜÁ±ªÂàõÂª∫ÂàÜÈ°µÊï∞ÊçÆ
const paginatedTools: Record<string, Tool[][]> = {};
for (const category of categories) {
    paginatedTools[category] = chunkArray(
        groupedTools[category],
        ITEMS_PER_PAGE,
    );
}
---

<PageLayout title="Toolbox | Nayuki Blog">
    <div class="container">
        <h1 class="page-title">Â∑•ÂÖ∑ÁÆ±</h1>
        <p class="page-desc">Â∏∏Áî®‰π¶Á≠æ„ÄÅÂú®Á∫øÂ∑•ÂÖ∑‰∏éËµÑÊ∫êÂØºËà™„ÄÇ</p>

        <div class="tools-container">
            {
                categories.map((category) => (
                    <section class="category-section" data-section={category}>
                        <div class="section-header">
                            <h2 class="category-title">{category}</h2>
                            {paginatedTools[category].length > 1 && (
                                <div class="pagination-controls">
                                    <button
                                        class="nav-btn prev-btn"
                                        disabled
                                        aria-label="‰∏ä‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="15 18 9 12 15 6" />
                                        </svg>
                                    </button>
                                    <span class="page-indicator">
                                        <span class="current-page">1</span> /{" "}
                                        <span class="total-pages">
                                            {paginatedTools[category].length}
                                        </span>
                                    </span>
                                    <button
                                        class="nav-btn next-btn"
                                        aria-label="‰∏ã‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="9 18 15 12 9 6" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div class="carousel-container">
                            {paginatedTools[category].map((page, pageIdx) => (
                                <div
                                    class={`carousel-page ${pageIdx === 0 ? "active" : ""}`}
                                    data-page={pageIdx}
                                >
                                    <div class="tools-grid">
                                        {page.map((tool) => (
                                            <ToolCard {...tool} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                ))
            }
        </div>
    </div>
</PageLayout>

<style>
    .container {
        max-width: 960px;
        margin: 0 auto;
    }
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .page-desc {
        color: #666;
        margin-bottom: 3rem;
    }

    .tools-container {
        display: flex;
        flex-direction: column;
        gap: 3rem;
    }

    .category-section {
        margin-bottom: 0;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .category-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .nav-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #ddd;
        background: #fff;
        color: #666;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .nav-btn:hover:not(:disabled) {
        border-color: #333;
        color: #333;
        background: #f5f5f5;
    }

    .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .page-indicator {
        font-size: 0.875rem;
        color: #666;
        min-width: 50px;
        text-align: center;
    }

    .current-page {
        font-weight: 600;
        color: #333;
    }

    .carousel-container {
        overflow: hidden;
        position: relative;
    }

    .carousel-page {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }

    .carousel-page.active {
        opacity: 1;
        visibility: visible;
        position: relative;
    }

    .tools-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 640px) {
        .tools-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .tools-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>

<script>
    // ‰∏∫ÊØè‰∏™ category section ÂàùÂßãÂåñËΩÆÊí≠ÂäüËÉΩ
    document.querySelectorAll(".category-section").forEach((section) => {
        const prevBtn = section.querySelector(".prev-btn") as HTMLButtonElement;
        const nextBtn = section.querySelector(".next-btn") as HTMLButtonElement;
        const currentPageSpan = section.querySelector(".current-page");
        const pages = section.querySelectorAll(".carousel-page");

        if (!prevBtn || !nextBtn || !currentPageSpan || pages.length === 0)
            return;

        const totalPages = pages.length;
        let currentPage = 0;

        const updateDisplay = () => {
            // Êõ¥Êñ∞È°µÁ†ÅÊòæÁ§∫
            currentPageSpan.textContent = String(currentPage + 1);

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === totalPages - 1;

            // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
            pages.forEach((page, idx) => {
                if (idx === currentPage) {
                    page.classList.add("active");
                } else {
                    page.classList.remove("active");
                }
            });
        };

        prevBtn.addEventListener("click", () => {
            if (currentPage > 0) {
                currentPage--;
                updateDisplay();
            }
        });

        nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                updateDisplay();
            }
        });
    });
</script>
