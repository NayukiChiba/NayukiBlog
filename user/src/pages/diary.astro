---
// ğŸš€ é™æ€é¢„æ¸²æŸ“
export const prerender = true;

import PageLayout from "../layouts/PageLayout.astro";
import DiaryCard from "../components/DiaryCard.astro";
import { apiUrl } from "../lib/api";

interface Diary {
    date: string;
    content: string;
    mood: string;
    weather: string;
    images: string[];
}

let diaries: Diary[] = [];
try {
    const response = await fetch(apiUrl("/api/user/diaries"));
    if (response.ok) {
        diaries = (await response.json()) as Diary[];
    } else {
        console.error(
            `Failed to fetch diaries: ${response.status} ${response.statusText}`,
        );
    }
} catch (error) {
    console.error("Failed to fetch diaries:", error);
}

// Sort diaries by date descending
diaries = diaries.sort(
    (a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf(),
);

// Group diaries by year and month
interface GroupedDiaries {
    [year: string]: {
        [month: string]: Diary[];
    };
}

const groupedDiaries: GroupedDiaries = {};
diaries.forEach((diary) => {
    const date = new Date(diary.date);
    const year = date.getFullYear().toString();
    const month = (date.getMonth() + 1).toString().padStart(2, "0");

    if (!groupedDiaries[year]) {
        groupedDiaries[year] = {};
    }
    if (!groupedDiaries[year][month]) {
        groupedDiaries[year][month] = [];
    }
    groupedDiaries[year][month].push(diary);
});

// Sort years descending
const years = Object.keys(groupedDiaries).sort(
    (a, b) => parseInt(b) - parseInt(a),
);

// Month names in Chinese
const monthNames = [
    "ä¸€æœˆ",
    "äºŒæœˆ",
    "ä¸‰æœˆ",
    "å››æœˆ",
    "äº”æœˆ",
    "å…­æœˆ",
    "ä¸ƒæœˆ",
    "å…«æœˆ",
    "ä¹æœˆ",
    "åæœˆ",
    "åä¸€æœˆ",
    "åäºŒæœˆ",
];
---

<PageLayout title="Diary | Nayuki Blog">
    <div class="container">
        <h1 class="page-title">ä¸ªäººæ—¥è®°</h1>
        <p class="page-desc">è®°å½•ç”Ÿæ´»ç‚¹æ»´ä¸ç¢ç¢å¿µã€‚</p>

        <div class="timeline" id="diary-timeline">
            {
                years.map((year) => {
                    const yearDiaries = groupedDiaries[year];
                    const months = Object.keys(yearDiaries).sort(
                        (a, b) => parseInt(b) - parseInt(a),
                    );
                    const yearCount = Object.values(yearDiaries).reduce(
                        (sum, monthDiaries) => sum + monthDiaries.length,
                        0,
                    );

                    return (
                        <div class="timeline-item year-section">
                            <div class="timeline-marker" />
                            <details class="year-accordion">
                                <summary class="timeline-summary year-summary">
                                    <span class="year-text">{year}å¹´</span>
                                    <span class="entry-count">
                                        ({yearCount} æ¡)
                                    </span>
                                </summary>

                                <div class="timeline-content year-content">
                                    {months.map((month) => {
                                        const monthDiaries = yearDiaries[month];
                                        const monthIndex = parseInt(month) - 1;
                                        const monthName =
                                            monthNames[monthIndex];

                                        return (
                                            <div class="timeline-item month-section">
                                                <div class="timeline-marker" />
                                                <details class="month-accordion">
                                                    <summary class="timeline-summary month-summary">
                                                        <span class="month-text">
                                                            {monthName}
                                                        </span>
                                                        <span class="entry-count">
                                                            (
                                                            {
                                                                monthDiaries.length
                                                            }{" "}
                                                            æ¡)
                                                        </span>
                                                    </summary>

                                                    <div class="timeline-content month-content">
                                                        <div class="diary-entries">
                                                            {monthDiaries.map(
                                                                (diary) => (
                                                                    <DiaryCard
                                                                        {...diary}
                                                                    />
                                                                ),
                                                            )}
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>
                                        );
                                    })}
                                </div>
                            </details>
                        </div>
                    );
                })
            }
        </div>
    </div>
</PageLayout>

<script>
    // Single-open accordion behavior
    const setupAccordionBehavior = () => {
        const timeline = document.getElementById("diary-timeline");
        if (!timeline) return;

        let currentOpenDiary: HTMLDetailsElement | null = null;

        // Handle diary card accordion behavior (only one diary open at a time)
        timeline.addEventListener(
            "toggle",
            (e) => {
                const target = e.target as HTMLDetailsElement;

                // Only handle diary-details accordions, not year/month accordions
                if (target.classList.contains("diary-details") && target.open) {
                    // Close previously open diary if there is one
                    if (currentOpenDiary && currentOpenDiary !== target) {
                        currentOpenDiary.open = false;
                    }
                    // Update current open diary
                    currentOpenDiary = target;
                }
            },
            true,
        ); // Use capture phase to catch events from nested elements
    };

    // Initialize on DOM ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupAccordionBehavior);
    } else {
        setupAccordionBehavior();
    }
</script>

<style>
    .container {
        max-width: 800px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .page-desc {
        color: #666;
        margin-bottom: 3rem;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 2rem;
        border-left: 2px solid #eee;
        margin-left: 1rem;
    }

    /* Year Section Styles */
    .year-section {
        margin-bottom: 3rem;
    }

    .year-accordion {
        width: 100%;
    }

    .year-summary {
        font-size: 1.4rem;
        font-weight: 700;
        color: #222;
        padding: 0.5rem 0;
    }

    .year-summary:hover {
        color: #000;
    }

    .year-text {
        margin-right: 0.5rem;
    }

    .entry-count {
        font-size: 0.9rem;
        font-weight: 500;
        color: #888;
    }

    .year-content {
        margin-top: 1.5rem;
        position: relative;
        padding-left: 2rem;
        border-left: 2px solid #f0f0f0;
        margin-left: 0.5rem;
    }

    /* Month Section Styles */
    .month-section {
        margin-bottom: 2rem;
    }

    .month-accordion {
        width: 100%;
    }

    .month-summary {
        font-size: 1.15rem;
        font-weight: 600;
        color: #444;
        padding: 0.3rem 0;
    }

    .month-summary:hover {
        color: #222;
    }

    .month-text {
        margin-right: 0.5rem;
    }

    .month-content {
        margin-top: 1rem;
    }

    /* Common Timeline Summary Styles */
    .timeline-summary {
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        transition: color 0.2s;
        user-select: none;
    }

    .timeline-summary::-webkit-details-marker {
        display: none;
    }

    /* Add arrow indicator for accordions */
    .year-summary::before,
    .month-summary::before {
        content: "â–¶";
        display: inline-block;
        margin-right: 0.5rem;
        font-size: 0.7em;
        transition: transform 0.2s;
        color: #999;
    }

    details[open] > .year-summary::before,
    details[open] > .month-summary::before {
        transform: rotate(90deg);
    }

    /* Diary Entries Container */
    .diary-entries {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    /* Animation for opening sections */
    .timeline-content {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .year-summary {
            font-size: 1.2rem;
        }

        .month-summary {
            font-size: 1rem;
        }

        .year-content {
            padding-left: 1.5rem;
        }
    }
</style>
