---
import Header from "../components/Header.astro";
import FloatingButton from "../components/FloatingButton.astro";
import PostHeader from "../components/Markdown/PostHeader.astro";
import TocSidebar from "../components/Markdown/TocSidebar.astro";
import TocMobile from "../components/Markdown/TocMobile.astro";
import "../styles/global.css"; // Import global styles for consistent header/variables
import CopyToast from "../components/Markdown/CopyToast.astro";
import ImageLightbox from "../components/Markdown/ImageLightbox.astro";
import MarkdownStyles from "../components/Markdown/MarkdownStyles.astro";
import MarkdownScripts from "../components/Markdown/MarkdownScripts.astro";
import ParticleBackground from "../components/ParticleBackground.astro";
import ProgressBar from "../components/ProgressBar.astro";

const { frontmatter } = Astro.props;
const date = new Date(frontmatter.date);
const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{frontmatter.title}</title>

    <!-- 字体预连接 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- KaTeX CSS - 使用 CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.css"
      crossorigin="anonymous"
    />

    <!-- KaTeX 公式已在构建时通过 KaTeX 渲染，无需客户端JS -->
    <!-- 代码高亮由 Astro 内置 Shiki 在构建时处理 -->

    <!-- ⬇️ 防止样式闪烁 (FOUC) 的脚本：在页面渲染前立即应用用户设置的主题色 -->
    <script is:inline>
      (function() {
        try {
          // 立即获取存储的主题
          const storedColor = localStorage.getItem('theme-color');
          const storedGradient = localStorage.getItem('theme-gradient');
          const root = document.documentElement;

          // 辅助函数：应用极速模式
          const applyTheme = (color, gradient) => {
             // 强制重置旧的紫色 (#8b5cf6) 或粉色 (#ff9eb5) 到新的默认蓝色 (#3b82f6)
             if (color === '#8b5cf6' || color === '#ff9eb5') {
                 color = '#3b82f6';
                 gradient = null;
                 localStorage.removeItem('theme-color');     // 清除旧的
                 localStorage.removeItem('theme-gradient');  // 清除旧的
                 // 不保存新的，让它回退到 CSS 默认值，或者保存新的蓝色
                 localStorage.setItem('theme-color', color);
             }

             root.style.setProperty('--color-primary', color);
             if (gradient) {
                root.style.setProperty('--gradient-primary', gradient);
                root.style.setProperty('--gradient-text', gradient);
             } else {
                // 如果没有渐变，生成一个基于单色的渐变（兼容旧数据）
                const fallback = `linear-gradient(135deg, ${color} 0%, ${color} 100%)`;
                root.style.setProperty('--gradient-primary', fallback);
                root.style.setProperty('--gradient-text', fallback);
             }
          };

          if (storedColor) {
            applyTheme(storedColor, storedGradient);
          }
          
          // 监听 astro:after-swap 事件以支持 View Transitions 导航时的样式保持
          document.addEventListener('astro:after-swap', () => {
             const c = localStorage.getItem('theme-color');
             const g = localStorage.getItem('theme-gradient');
             if(c) applyTheme(c, g);
          });
          
        } catch (e) {
          console.error('Failed to restore theme color:', e);
        }
      })();
    </script>
  </head>
  <body>
    <Header />
    <main class="markdown-container page-enter">
      <article class="content">
        <PostHeader
          title={frontmatter.title}
          formattedDate={formattedDate}
          description={frontmatter.description}
          tags={frontmatter.tags}
        />
        <hr />
        <slot />
      </article>
    </main>

    <!-- 桌面端固定目录 -->
    <TocSidebar />

    <!-- 移动端目录悬浮按钮和抽屉 -->
    <TocMobile />

    <!-- Copy Toast Notification -->
    <CopyToast />

    <!-- 图片预览灯箱 -->
    <ImageLightbox />

    <!-- 初始化脚本 -->
    <MarkdownScripts />

    <FloatingButton />

    <ParticleBackground />
    <ProgressBar />
  </body>
</html>

<!-- 全局样式 -->
<MarkdownStyles />

<style is:global>
  /* Restore basic resets since this layout doesn't use PageLayout */
  html {
    overflow-x: hidden;
    width: 100%;
  }

  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* Prevent horizontal scroll from wide elements */
    min-height: 100vh;
    width: 100%;
    display: flex;
    flex-direction: column;
    background-color: var(--color-bg, #fff); /* Fallback */
  }

  /* Ensure footer/content fills height and handles width properly in flex */
  main {
    flex: 1;
    width: 100%;
    min-width: 0; /* CRITICAL: allows flex item to shrink smaller than content (e.g. wide tables) */
    box-sizing: border-box; /* Ensure padding doesn't add to width */
    position: relative;
    z-index: 1;
  }
</style>
