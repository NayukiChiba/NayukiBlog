---
import Header from "../components/Header.astro";
import FloatingButton from "../components/FloatingButton.astro";
import PostHeader from "../components/Markdown/PostHeader.astro";
import TocSidebar from "../components/Markdown/TocSidebar.astro";
import TocMobile from "../components/Markdown/TocMobile.astro";
import "../styles/global.css"; // Import global styles for consistent header/variables
import CopyToast from "../components/Markdown/CopyToast.astro";
import ImageLightbox from "../components/Markdown/ImageLightbox.astro";
import MarkdownStyles from "../components/Markdown/MarkdownStyles.astro";
import MarkdownScripts from "../components/Markdown/MarkdownScripts.astro";
import ParticleBackground from "../components/ParticleBackground.astro";
import ProgressBar from "../components/ProgressBar.astro";

const { frontmatter } = Astro.props;
const date = new Date(frontmatter.date);
const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{frontmatter.title}</title>

    <!-- 字体预连接 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- KaTeX CSS - 使用 CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.css"
      crossorigin="anonymous"
    />

    <!-- KaTeX 公式已在构建时通过 KaTeX 渲染，无需客户端JS -->
    <!-- 代码高亮由 Astro 内置 Shiki 在构建时处理 -->

    <!-- ⬇️ 防止样式闪烁 (FOUC) 的脚本：在页面渲染前立即应用用户设置的主题色 -->
    <script is:inline>
      (function() {
        try {
          const root = document.documentElement;
          const c1 = localStorage.getItem('theme-color-1');
          const c2 = localStorage.getItem('theme-color-2');
          if (c1 && c2) {
            root.style.setProperty('--color-primary', c1);
            root.style.setProperty('--color-secondary', c2);
            root.style.setProperty('--radial-c1', c1);
            root.style.setProperty('--radial-c2', c2);
            root.style.setProperty('--color-accent', c2);
          }
          // 监听 View Transitions 导航时的样式恢复
          document.addEventListener('astro:after-swap', () => {
            const _c1 = localStorage.getItem('theme-color-1');
            const _c2 = localStorage.getItem('theme-color-2');
            if (_c1 && _c2) {
              document.documentElement.style.setProperty('--color-primary', _c1);
              document.documentElement.style.setProperty('--color-secondary', _c2);
              document.documentElement.style.setProperty('--radial-c1', _c1);
              document.documentElement.style.setProperty('--radial-c2', _c2);
              document.documentElement.style.setProperty('--color-accent', _c2);
            }
          });
        } catch (e) {
          console.error('Failed to restore theme color:', e);
        }
      })();
    </script>
  </head>
  <body>
    <Header />
    <main class="markdown-container page-enter">
      <article class="content">
        <PostHeader
          title={frontmatter.title}
          formattedDate={formattedDate}
          description={frontmatter.description}
          tags={frontmatter.tags}
        />
        <hr />
        <slot />
      </article>
    </main>

    <!-- 桌面端固定目录 -->
    <TocSidebar />

    <!-- 移动端目录悬浮按钮和抽屉 -->
    <TocMobile />

    <!-- Copy Toast Notification -->
    <CopyToast />

    <!-- 图片预览灯箱 -->
    <ImageLightbox />

    <!-- 初始化脚本 -->
    <MarkdownScripts />

    <FloatingButton />

    <ParticleBackground />
    <ProgressBar />
  </body>
</html>

<!-- 全局样式 -->
<MarkdownStyles />

<style is:global>
  /* Restore basic resets since this layout doesn't use PageLayout */
  html {
    overflow-x: hidden;
    width: 100%;
  }

  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* Prevent horizontal scroll from wide elements */
    min-height: 100vh;
    width: 100%;
    display: flex;
    flex-direction: column;
    background: transparent; /* 由 body::before 渐变层提供背景 */
  }

  /* Ensure footer/content fills height and handles width properly in flex */
  main {
    flex: 1;
    width: 100%;
    min-width: 0; /* CRITICAL: allows flex item to shrink smaller than content (e.g. wide tables) */
    box-sizing: border-box; /* Ensure padding doesn't add to width */
    position: relative;
    z-index: 1;
  }
</style>
