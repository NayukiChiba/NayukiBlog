---
import Header from "../components/Header.astro";
import FloatingButton from "../components/FloatingButton.astro";
import PostHeader from "../components/Markdown/PostHeader.astro";
import TocSidebar from "../components/Markdown/TocSidebar.astro";
import TocMobile from "../components/Markdown/TocMobile.astro";
import "../styles/global.css"; // Import global styles for consistent header/variables
import CopyToast from "../components/Markdown/CopyToast.astro";
import ImageLightbox from "../components/Markdown/ImageLightbox.astro";
import MarkdownStyles from "../components/Markdown/MarkdownStyles.astro";
import MarkdownScripts from "../components/Markdown/MarkdownScripts.astro";
import ParticleBackground from "../components/ParticleBackground.astro";

const { frontmatter } = Astro.props;
const date = new Date(frontmatter.date);
const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{frontmatter.title}</title>
    <!-- KaTeX CSS - 使用 CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.css"
      crossorigin="anonymous"
    />
    <!-- KaTeX 公式已在构建时通过 KaTeX 渲染，无需客户端JS -->

    <!-- Prism.js 代码高亮 - 使用 CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.staticfile.net/prism/1.29.0/themes/prism.min.css"
      crossorigin="anonymous"
    />
    <script
      is:inline
      defer
      src="https://cdn.staticfile.net/prism/1.29.0/prism.min.js"
      crossorigin="anonymous"></script>
    <script
      is:inline
      defer
      src="https://cdn.staticfile.net/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"
      crossorigin="anonymous"></script>
  </head>
  <body>
    <Header />
    <main class="markdown-container page-enter">
      <article class="content">
        <PostHeader
          title={frontmatter.title}
          formattedDate={formattedDate}
          description={frontmatter.description}
          tags={frontmatter.tags}
        />
        <hr />
        <slot />
      </article>
    </main>

    <!-- 桌面端固定目录 -->
    <TocSidebar />

    <!-- 移动端目录悬浮按钮和抽屉 -->
    <TocMobile />

    <!-- Copy Toast Notification -->
    <CopyToast />

    <!-- 图片预览灯箱 -->
    <ImageLightbox />

    <!-- 初始化脚本 -->
    <MarkdownScripts />

    <FloatingButton />

    <ParticleBackground />
  </body>
</html>

<!-- 全局样式 -->
<MarkdownStyles />

<style is:global>
  /* Restore basic resets since this layout doesn't use PageLayout */
  html {
    overflow-x: hidden;
    width: 100%;
  }

  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* Prevent horizontal scroll from wide elements */
    min-height: 100vh;
    width: 100%;
    display: flex;
    flex-direction: column;
    background-color: var(--color-bg, #fff); /* Fallback */
  }

  /* Ensure footer/content fills height and handles width properly in flex */
  main {
    flex: 1;
    width: 100%;
    min-width: 0; /* CRITICAL: allows flex item to shrink smaller than content (e.g. wide tables) */
    box-sizing: border-box; /* Ensure padding doesn't add to width */
  }
</style>
