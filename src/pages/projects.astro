---
import PageLayout from "../layouts/PageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { getProjects, type Project } from "../lib/data";

// ‰ªéÊú¨Âú∞ JSON ËØªÂèñÈ°πÁõÆÊï∞ÊçÆ
const projects = getProjects({ visibility: "published" });

// Helper to map data format
const mapProject = (p: Project) => ({
    title: p.name,
    desc: p.description || "",
    url: p.link || "",
    tech: p.techStack || [],
});

const inProgressProjects = projects
    .filter((p) => p.status === "in-progress")
    .map(mapProject);
const completedProjects = projects
    .filter((p) => p.status === "completed")
    .map(mapProject);
const planningProjects = projects
    .filter((p) => p.status === "planning")
    .map(mapProject);

// ÂàÜÈ°µËæÖÂä©ÂáΩÊï∞ÔºöÂ∞ÜÈ°πÁõÆÂàÜÊàêÊØè4‰∏™‰∏ÄÁªÑ
const chunkArray = <T,>(arr: T[], size: number): T[][] => {
    const chunks: T[][] = [];
    for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
    }
    return chunks;
};

const ITEMS_PER_PAGE = 4;
const inProgressPages = chunkArray(inProgressProjects, ITEMS_PER_PAGE);
const completedPages = chunkArray(completedProjects, ITEMS_PER_PAGE);
const planningPages = chunkArray(planningProjects, ITEMS_PER_PAGE);
---

<PageLayout title="Projects | Nayuki Blog">
    <div class="page-container">
        <h1 class="page-title">ÂºÄÊ∫êÈ°πÁõÆ</h1>
        <p class="page-desc">ËøôÈáåÂ±ïÁ§∫‰∫ÜÊàëÁöÑ‰∏Ä‰∫õÂºÄÊ∫êÈ°πÁõÆÂíåÂÆûÈ™åÊÄß‰ΩúÂìÅ„ÄÇ</p>

        <div class="sections-wrapper">
            <!-- In Progress -->
            {
                inProgressProjects.length > 0 && (
                    <section class="project-section" data-section="in-progress">
                        <div class="section-header">
                            <h2 class="section-title">
                                üöß Ê≠£Âú®ËøõË°å (In Progress)
                            </h2>
                            {inProgressPages.length > 1 && (
                                <div class="pagination-controls">
                                    <button
                                        class="nav-btn prev-btn"
                                        disabled
                                        aria-label="‰∏ä‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="15 18 9 12 15 6" />
                                        </svg>
                                    </button>
                                    <span class="page-indicator">
                                        <span class="current-page">1</span> /{" "}
                                        <span class="total-pages">
                                            {inProgressPages.length}
                                        </span>
                                    </span>
                                    <button
                                        class="nav-btn next-btn"
                                        aria-label="‰∏ã‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="9 18 15 12 9 6" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div class="carousel-container">
                            {inProgressPages.map((page, pageIdx) => (
                                <div
                                    class={`carousel-page ${pageIdx === 0 ? "active" : ""}`}
                                    data-page={pageIdx}
                                >
                                    <div class="project-grid">
                                        {page.map((project) => (
                                            <ProjectCard {...project} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                )
            }

            <!-- Planning (ÁßªÂà∞ Completed ÂâçÈù¢) -->
            {
                planningProjects.length > 0 && (
                    <section class="project-section" data-section="planning">
                        <div class="section-header">
                            <h2 class="section-title">
                                üí° Ê≠£Âú®Êñ∞Âª∫‰ªìÂ∫ì (Planning)
                            </h2>
                            {planningPages.length > 1 && (
                                <div class="pagination-controls">
                                    <button
                                        class="nav-btn prev-btn"
                                        disabled
                                        aria-label="‰∏ä‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="15 18 9 12 15 6" />
                                        </svg>
                                    </button>
                                    <span class="page-indicator">
                                        <span class="current-page">1</span> /{" "}
                                        <span class="total-pages">
                                            {planningPages.length}
                                        </span>
                                    </span>
                                    <button
                                        class="nav-btn next-btn"
                                        aria-label="‰∏ã‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="9 18 15 12 9 6" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div class="carousel-container">
                            {planningPages.map((page, pageIdx) => (
                                <div
                                    class={`carousel-page ${pageIdx === 0 ? "active" : ""}`}
                                    data-page={pageIdx}
                                >
                                    <div class="project-grid">
                                        {page.map((project) => (
                                            <ProjectCard {...project} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                )
            }

            <!-- Completed (ÁßªÂà∞ Planning ÂêéÈù¢) -->
            {
                completedProjects.length > 0 && (
                    <section class="project-section" data-section="completed">
                        <div class="section-header">
                            <h2 class="section-title">‚úÖ Â∑≤ÂÆåÊàê (Completed)</h2>
                            {completedPages.length > 1 && (
                                <div class="pagination-controls">
                                    <button
                                        class="nav-btn prev-btn"
                                        disabled
                                        aria-label="‰∏ä‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="15 18 9 12 15 6" />
                                        </svg>
                                    </button>
                                    <span class="page-indicator">
                                        <span class="current-page">1</span> /{" "}
                                        <span class="total-pages">
                                            {completedPages.length}
                                        </span>
                                    </span>
                                    <button
                                        class="nav-btn next-btn"
                                        aria-label="‰∏ã‰∏ÄÈ°µ"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polyline points="9 18 15 12 9 6" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div class="carousel-container">
                            {completedPages.map((page, pageIdx) => (
                                <div
                                    class={`carousel-page ${pageIdx === 0 ? "active" : ""}`}
                                    data-page={pageIdx}
                                >
                                    <div class="project-grid">
                                        {page.map((project) => (
                                            <ProjectCard {...project} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                )
            }
        </div>
    </div>
</PageLayout>

<style>
    .page-container {
        max-width: 960px;
        margin: 0 auto;
    }
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: var(--color-text);
    }
    .page-desc {
        color: var(--color-text-light);
        margin-bottom: 3.5rem;
        font-size: 1rem;
    }

    .sections-wrapper {
        display: flex;
        flex-direction: column;
        gap: 5rem;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--color-border);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text);
        margin: 0;
        position: relative;
        padding-left: 1rem;
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 1.4em;
        background: linear-gradient(180deg, var(--color-primary), var(--color-primary-light));
        border-radius: 2px;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .nav-btn {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        border: 1px solid var(--color-border);
        background: var(--color-card-bg);
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .nav-btn:hover:not(:disabled) {
        border-color: var(--color-primary);
        color: var(--color-primary);
        background: var(--color-primary-subtle);
        transform: scale(1.05);
    }

    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .page-indicator {
        font-size: 0.875rem;
        color: var(--color-text-light);
        min-width: 50px;
        text-align: center;
        font-weight: 500;
    }

    .current-page {
        font-weight: 700;
        color: var(--color-primary);
    }

    .carousel-container {
        overflow: hidden;
        position: relative;
    }

    .carousel-page {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }

    .carousel-page.active {
        opacity: 1;
        visibility: visible;
        position: relative;
    }

    .project-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    @media (min-width: 640px) {
        .project-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<script>
    // ‰∏∫ÊØè‰∏™ section ÂàùÂßãÂåñËΩÆÊí≠ÂäüËÉΩ
    document.querySelectorAll(".project-section").forEach((section) => {
        const prevBtn = section.querySelector(".prev-btn") as HTMLButtonElement;
        const nextBtn = section.querySelector(".next-btn") as HTMLButtonElement;
        const currentPageSpan = section.querySelector(".current-page");
        const pages = section.querySelectorAll(".carousel-page");

        if (!prevBtn || !nextBtn || !currentPageSpan || pages.length === 0)
            return;

        const totalPages = pages.length;
        let currentPage = 0;

        const updateDisplay = () => {
            // Êõ¥Êñ∞È°µÁ†ÅÊòæÁ§∫
            currentPageSpan.textContent = String(currentPage + 1);

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === totalPages - 1;

            // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
            pages.forEach((page, idx) => {
                if (idx === currentPage) {
                    page.classList.add("active");
                } else {
                    page.classList.remove("active");
                }
            });
        };

        prevBtn.addEventListener("click", () => {
            if (currentPage > 0) {
                currentPage--;
                updateDisplay();
            }
        });

        nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                updateDisplay();
            }
        });
    });
</script>
