---
/**
 * 文章搜索框组件
 *
 * 通信方式（自定义事件）：
 *   向外派发 `article:search`  —— detail: { query: string }
 *   监听     `article:search-result` —— detail: { query: string; count: number }
 */
---

<div class="article-search">
    <div class="sidebar-title">搜索</div>
    <div class="search-box">
        <svg
            class="search-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="15"
            height="15"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input
            type="text"
            class="search-input"
            placeholder="搜索标题、简介、内容…"
            autocomplete="off"
            spellcheck="false"
        />
        <button class="search-clear" title="清除搜索" style="display:none">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="search-hint"></div>
</div>

<script>
    function initArticleSearch() {
        // 每个 .article-search 实例独立初始化（桌面端 + 移动端抽屉各一个）
        const sections = document.querySelectorAll(".article-search");

        // 派发搜索事件的公共函数
        const dispatch = (query: string) => {
            document.dispatchEvent(
                new CustomEvent("article:search", { detail: { query } }),
            );
        };

        sections.forEach((section) => {
            const input = section.querySelector(
                ".search-input",
            ) as HTMLInputElement;
            const clearBtn = section.querySelector(
                ".search-clear",
            ) as HTMLButtonElement;

            if (!input || !clearBtn) return;

            // 避免重复绑定
            if ((input as any)._searchBound) return;
            (input as any)._searchBound = true;

            input.addEventListener("input", () => {
                const query = input.value;

                // 同步所有搜索框的值
                document
                    .querySelectorAll<HTMLInputElement>(
                        ".article-search .search-input",
                    )
                    .forEach((other) => {
                        if (other !== input) other.value = query;
                    });

                // 同步清除按钮状态
                document
                    .querySelectorAll<HTMLButtonElement>(
                        ".article-search .search-clear",
                    )
                    .forEach((btn) => {
                        btn.style.display = query ? "flex" : "none";
                    });

                dispatch(query);
            });

            clearBtn.addEventListener("click", () => {
                // 清空所有搜索框
                document
                    .querySelectorAll<HTMLInputElement>(
                        ".article-search .search-input",
                    )
                    .forEach((inp) => {
                        inp.value = "";
                    });
                document
                    .querySelectorAll<HTMLButtonElement>(
                        ".article-search .search-clear",
                    )
                    .forEach((btn) => {
                        btn.style.display = "none";
                    });

                dispatch("");
            });
        });

        // 监听父页面回传的搜索结果，更新所有 hint
        const onSearchResult = (e: Event) => {
            const { query, count } = (e as CustomEvent<{ query: string; count: number }>).detail;
            document
                .querySelectorAll<HTMLElement>(".article-search .search-hint")
                .forEach((hint) => {
                    if (query) {
                        hint.textContent = `找到 ${count} 篇文章`;
                        hint.style.display = "block";
                        hint.className =
                            "search-hint" + (count === 0 ? " no-result" : "");
                    } else {
                        hint.textContent = "";
                        hint.style.display = "none";
                    }
                });
        };

        // 防止重复绑定全局监听器
        document.removeEventListener("article:search-result", onSearchResult);
        document.addEventListener("article:search-result", onSearchResult);
    }

    initArticleSearch();
    document.addEventListener("astro:page-load", initArticleSearch);
</script>

<style>
    .article-search {
        margin-bottom: 0;
    }

    .sidebar-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
        background: var(--color-bg);
        border: 1.5px solid var(--color-border);
        border-radius: 10px;
        padding: 0 0.75rem;
        gap: 0.5rem;
        transition:
            border-color 0.2s ease,
            box-shadow 0.2s ease;
    }

    .search-box:focus-within {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-subtle, rgba(255, 158, 181, 0.15));
    }

    .search-icon {
        color: var(--color-text-muted);
        flex-shrink: 0;
        transition: color 0.2s;
    }

    .search-box:focus-within .search-icon {
        color: var(--color-primary);
    }

    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.6rem 0;
        font-size: 0.85rem;
        font-family: inherit;
        color: var(--color-text);
        outline: none;
        min-width: 0;
    }

    .search-input::placeholder {
        color: var(--color-text-muted);
        font-size: 0.82rem;
    }

    .search-clear {
        flex-shrink: 0;
        display: none;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border: none;
        background: var(--color-border);
        border-radius: 50%;
        cursor: pointer;
        color: var(--color-text-muted);
        padding: 0;
        transition: background 0.2s, color 0.2s;
    }

    .search-clear:hover {
        background: var(--color-primary-light, #ffb3c8);
        color: var(--color-primary-dark, #c0436c);
    }

    .search-hint {
        display: none;
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.78rem;
        color: var(--color-primary-dark, #c0436c);
        background: var(--color-primary-subtle, rgba(255, 158, 181, 0.12));
        border-radius: 6px;
    }

    .search-hint.no-result {
        color: var(--color-text-muted);
        background: var(--color-bg-secondary);
    }
</style>
