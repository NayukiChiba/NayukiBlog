---
// MarkdownScripts.astro - Markdown 页面的所有初始化脚本
---

<script is:inline>
  // 初始化
  document.addEventListener("DOMContentLoaded", () => {
    // 0. Obsidian Callout 支持 (Info, Tip, Warning, Danger)
    const blockquotes = document.querySelectorAll(".content blockquote");
    blockquotes.forEach((bq) => {
      const firstP = bq.querySelector("p");
      if (!firstP) return;

      const text = firstP.innerHTML;
      const match = text.match(
        /^\[!(NOTE|TIP|WARNING|DANGER|INFO|ERROR|SUCCESS|CHECK|DONE|QUESTION|FAQ|HELP|ABSTRACT|SUMMARY|TLDR|BUG|EXAMPLE|QUOTE|CITE|TODO)\](.*?)(<br>|\n|$)/i,
      );

      if (match) {
        const type = match[1].toLowerCase(); // note, tip, warning, danger
        const titleText = match[2].trim() || type.toUpperCase();

        // 创建 Callout 容器
        const callout = document.createElement("div");
        callout.className = `callout callout-${type}`;

        // 创建标题
        const title = document.createElement("div");
        title.className = "callout-title";
        // 添加图标 (根据类型)
        let iconSvg = "";
        switch (type) {
          case "note":
          case "info":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            break;
          case "tip":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-5 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a7 7 0 0 0 14 0"></path><path d="M11 19h2"></path></svg>';
            break;
          case "warning":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            break;
          case "danger":
          case "error":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            break;
          case "success":
          case "check":
          case "done":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            break;
          case "question":
          case "faq":
          case "help":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            break;
          case "abstract":
          case "summary":
          case "tldr":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="11" y2="18"></line></svg>';
            break;
          case "bug":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="14" rx="4"></rect><path d="m19 7-3 2"></path><path d="m5 7 3 2"></path><path d="m19 19-3-2"></path><path d="m5 19 3-2"></path><path d="M20 13h-4"></path><path d="M4 13h4"></path><path d="m10 4 1 2"></path><path d="m14 4-1 2"></path></svg>';
            break;
          case "example":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>';
            break;
          case "quote":
          case "cite":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 2v6c0 1.25.75 2 2 2h.75L3 21z"></path><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 2v6c0 1.25.75 2 2 2h.75L15 21z"></path></svg>';
            break;
          case "todo":
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10"></path><polyline points="12 6 12 12 16 14"></polyline><line x1="22" y1="19" x2="16" y2="19"></line><line x1="19" y1="16" x2="19" y2="22"></line></svg>';
            break;
          default:
            iconSvg =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
        }

        title.innerHTML = `<span class="callout-icon">${iconSvg}</span><span class="callout-text">${titleText}</span>`;
        callout.appendChild(title);

        // 创建内容区
        const content = document.createElement("div");
        content.className = "callout-content";

        // 将原 Blockquote 的所有子节点移入新的 Content 容器
        while (bq.firstChild) {
          content.appendChild(bq.firstChild);
        }

        // 在新容器里找到那个 P (原第一个P)
        const newFirstP = content.querySelector("p");
        if (newFirstP) {
          // 去除标记文本
          newFirstP.innerHTML = text.replace(
            /^\[!(NOTE|TIP|WARNING|DANGER|INFO|ERROR|SUCCESS|CHECK|DONE|QUESTION|FAQ|HELP|ABSTRACT|SUMMARY|TLDR|BUG|EXAMPLE|QUOTE|CITE|TODO)\](.*?)(\n|<br>|$)/i,
            "",
          );
          // 如果剩下的全是空字符，移除该 P
          if (newFirstP.innerText.trim() === "") {
            newFirstP.remove();
          }
        }

        callout.appendChild(content);

        // 替换原 Blockquote
        bq.parentNode?.replaceChild(callout, bq);
      }
    });

    // 代码高亮由 Astro 内置 Shiki 在构建时处理，无需客户端 JS

    // KaTeX 已在 MarkdownLayout.astro 的 head 中初始化

    // TOC Toggle Logic
    const tocHeader = document.getElementById("toc-header-clickable");
    const tocToggle = document.getElementById("toc-toggle");
    const tocNav = document.getElementById("article-toc");

    if (tocHeader && tocToggle && tocNav) {
      const toggleToc = () => {
        tocNav.classList.toggle("collapsed");
        tocToggle.classList.toggle("collapsed");
      };

      tocHeader.addEventListener("click", toggleToc);
    }

    // 处理代码块：添加 Header、Language、Copy、Collapse
    const codeBlocks = document.querySelectorAll(".content pre"); 

    codeBlocks.forEach((pre) => {
      // 避免重复处理
      if (pre.closest(".code-block-wrapper")) return;

      // 0. 尝试获取语言
      let lang = "TEXT";
      
      // Shiki 使用 data-language 属性
      const dataLang = pre.getAttribute("data-language");
      if (dataLang) {
          lang = dataLang.toUpperCase();
          if (lang === "PLAINTEXT" || lang === "NONE" || lang === "TEXT") lang = "TEXT";
      } else {
          // Fallback: Check pre class (Prism 格式: 'language-xxx')
          let classes = Array.from(pre.classList);
          let langClass = classes.find((c) => c.startsWith("language-"));
          
          if (!langClass) {
              const code = pre.querySelector("code");
              if (code) {
                  classes = Array.from(code.classList);
                  langClass = classes.find((c) => c.startsWith("language-"));
              }
          }

          if (langClass) {
              lang = langClass.replace("language-", "").toUpperCase();
              if (lang === "PLAINTEXT" || lang === "NONE") lang = "TEXT";
          }
      }

      // 1. 创建包裹结构
      const wrapper = document.createElement("div");
      wrapper.className = "code-block-wrapper"; 

      // Insert wrapper before pre
      pre.parentNode?.insertBefore(wrapper, pre);
      
      // 2. Head Construction
      const header = document.createElement("div");
      header.className = "code-header";
      header.innerHTML = `
        <span class="code-language">${lang}</span>
        <div class="code-actions">
            <button class="code-btn copy-btn" title="Copy">
                <svg viewBox="0 0 24 24" fill="none" class="icon-copy" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg viewBox="0 0 24 24" fill="none" class="icon-check" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </button>
            <button class="code-btn code-collapse-btn" title="Toggle Reference">
                <svg viewBox="0 0 24 24" fill="none" class="icon-chevron" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </div>
      `;
      wrapper.appendChild(header);

      // 3. Content Container
      const content = document.createElement("div");
      content.className = "code-content expanded";
      content.appendChild(pre);
      wrapper.appendChild(content);

      // 4. Logic - Copy
      const copyBtn = header.querySelector(".copy-btn");
      copyBtn.addEventListener("click", () => {
        const text = pre.innerText;
        navigator.clipboard.writeText(text).then(() => {
            copyBtn.classList.add("copied");
            
            // Show toast if available
            const toast = document.getElementById("copy-toast");
            if (toast) {
                toast.style.opacity = "1";
                toast.style.transform = "translateX(-50%) translateY(0)";
                setTimeout(() => {
                    toast.style.opacity = "0";
                    toast.style.transform = "translateX(-50%) translateY(20px)";
                }, 2000);
            }

            setTimeout(() => {
                copyBtn.classList.remove("copied");
            }, 2000);
        });
      });

      // 5. Logic - Collapse
      const collapseBtn = header.querySelector(".code-collapse-btn");
      collapseBtn.addEventListener("click", () => {
          wrapper.classList.toggle("collapsed");
      });
    });

    // 处理表格：添加包装器以支持横向滚动
    const tables = document.querySelectorAll(".content table");
    tables.forEach((table) => {
      const wrapper = document.createElement("div");
      wrapper.className = "table-wrapper";
      table.parentNode?.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    });

    // 简介打字机效果
    const card = document.querySelector(".description-card");
    if (card) {
      const content = card.querySelector(".description-content");
      if (content) {
        const text = content.getAttribute("data-text") || "";

        // 清空内容准备打字
        content.innerText = "";

        let i = 0;
        function typeWriter() {
          if (i < text.length) {
            content.innerHTML += text.charAt(i);
            i++;
            setTimeout(typeWriter, 20); // 打字速度
          }
        }
        // 稍微延迟一点开始，让页面先渲染出来
        setTimeout(typeWriter, 300);
      }
    }

    // 自动生成目录 (TOC) 与 滚动监听
    const tocContainer = document.getElementById("article-toc");
    const mobileTocContainer = document.getElementById("mobile-toc");
    const contentEl = document.querySelector(".content");

    // 移动端目录抽屉逻辑
    const tocFloatBtn = document.getElementById("toc-float-btn");
    const tocDrawer = document.getElementById("toc-drawer");
    const tocOverlay = document.getElementById("toc-overlay");
    const tocDrawerClose = document.getElementById("toc-drawer-close");

    // 确保初始状态关闭
    tocDrawer?.classList.remove("open");
    tocOverlay?.classList.remove("visible");

    function openTocDrawer() {
      tocDrawer?.classList.add("open");
      tocOverlay?.classList.add("visible");
      document.body.style.overflow = "hidden";
    }

    function closeTocDrawer() {
      tocDrawer?.classList.remove("open");
      tocOverlay?.classList.remove("visible");
      document.body.style.overflow = "";
    }

    tocFloatBtn?.addEventListener("click", openTocDrawer);
    tocDrawerClose?.addEventListener("click", closeTocDrawer);
    tocOverlay?.addEventListener("click", closeTocDrawer);

    if ((tocContainer || mobileTocContainer) && contentEl) {
      // 获取所有标题
      const headings = contentEl.querySelectorAll("h1, h2, h3, h4");

      if (headings.length > 0) {
        // 为桌面端和移动端都生成目录
        const createTocList = (forMobile = false) => {
          const ul = document.createElement("ul");

          headings.forEach((heading, index) => {
            // 确保标题有 ID
            if (!heading.id) {
              heading.id = "heading-" + index;
            }

            const li = document.createElement("li");
            const level = parseInt(heading.tagName.substring(1));
            li.className = `toc-item level-${level}`;
            li.dataset.level = level.toString();

            const div = document.createElement("div");
            div.className = "toc-item-container";

            const a = document.createElement("a");
            a.href = "#" + heading.id;
            a.textContent = heading.textContent;

            a.addEventListener("click", (e) => {
              e.preventDefault();
              heading.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
              history.replaceState(null, "", "#" + heading.id);
              // 如果是移动端，关闭抽屉
              if (forMobile) {
                closeTocDrawer();
              }
            });

            div.appendChild(a);
            li.appendChild(div);
            ul.appendChild(li);
          });

          return ul;
        };

        // 桌面端目录
        if (tocContainer) {
          tocContainer.appendChild(createTocList(false));

          // 添加折叠功能（仅桌面端）
          const tocItems = tocContainer.querySelectorAll(".toc-item");
          tocItems.forEach((item, index) => {
            const currentLevel = parseInt(item.dataset.level || "0");
            const nextItem = tocItems[index + 1];

            if (nextItem) {
              const nextLevel = parseInt(nextItem.dataset.level || "0");
              if (nextLevel > currentLevel) {
                const btn = document.createElement("span");
                btn.className = "toc-collapse-btn";
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

                const container = item.querySelector(".toc-item-container");
                if (container) {
                  container.appendChild(btn);
                  item.classList.add("has-children");
                }

                btn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  btn.classList.toggle("collapsed");
                  const isCollapsed = btn.classList.contains("collapsed");

                  for (let i = index + 1; i < tocItems.length; i++) {
                    const sibling = tocItems[i];
                    const siblingLevel = parseInt(sibling.dataset.level || "0");

                    if (siblingLevel <= currentLevel) break;

                    if (isCollapsed) {
                      sibling.classList.add("hidden-by-parent");
                    } else {
                      sibling.classList.remove("hidden-by-parent");
                    }
                  }
                });
              }
            }
          });
        }

        // 移动端目录
        if (mobileTocContainer) {
          mobileTocContainer.appendChild(createTocList(true));
        }

        // 滚动监听 (Intersection Observer)
        const observerOptions = {
          root: null,
          rootMargin: "-100px 0px -70% 0px",
          threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              document
                .querySelectorAll(".toc-item a")
                .forEach((link) => link.classList.remove("active"));

              const id = entry.target.id;
              const activeLinks = document.querySelectorAll(
                `.toc-item a[href="#${id}"]`,
              );
              activeLinks.forEach((activeLink) => {
                activeLink.classList.add("active");
                
                // 自动滚动目录，使当前高亮项保持可见
                const tocNav = activeLink.closest("#article-toc");
                if (tocNav) {
                  const linkRect = activeLink.getBoundingClientRect();
                  const tocRect = tocNav.getBoundingClientRect();
                  
                  // 如果高亮项在目录可视区域外，滚动到中间位置
                  if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                    activeLink.scrollIntoView({
                      behavior: "smooth",
                      block: "center",
                    });
                  }
                }
              });
            }
          });
        }, observerOptions);

        headings.forEach((h) => observer.observe(h));
      } else {
        // 如果没有标题，隐藏目录栏和移动端按钮
        const sidebar = document.querySelector(".toc-sidebar");
        const mobileBtn = document.querySelector(".mobile-toc-btn");
        if (sidebar) sidebar.style.display = "none";
        if (mobileBtn) mobileBtn.style.display = "none";
      }
    }
  });
</script>
