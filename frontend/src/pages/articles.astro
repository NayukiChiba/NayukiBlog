---
import PageLayout from '../layouts/PageLayout.astro';
import PostCard from '../components/PostCard.astro';
import postsData from '../data/posts.json';

const posts = postsData
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

const tagCounts = posts.flatMap(post => post.tags || []).reduce((acc: Record<string, number>, tag) => {
  acc[tag] = (acc[tag] || 0) + 1;
  return acc;
}, {});

const tagsWithCount = Object.entries(tagCounts)
  .map(([tag, count]) => ({ tag, count }))
  .sort((a, b) => a.tag.localeCompare(b.tag));

const maxCount = Math.max(...tagsWithCount.map(t => t.count));
const minCount = Math.min(...tagsWithCount.map(t => t.count));

const getTagSize = (count: number) => {
  const minSize = 0.85;
  const maxSize = 1.3;
  if (maxCount === minCount) return minSize;
  return minSize + ((count - minCount) / (maxCount - minCount)) * (maxSize - minSize);
};
---

<PageLayout title="Articles | Nayuki Blog">
  <div class="page-container">
    <h1 class="page-title">文章与笔记</h1>
    <p class="page-desc">技术教程、学习笔记与思考。</p>
    
    <div class="filter-container">
      <div class="filter-left"></div>
      <div class="filter-separator"></div>
      <div class="filter-right">
        <div class="tags-box">
          <button class="tag-btn active" data-tag="" style="font-size: 1rem">全部</button>
          {tagsWithCount.map(({ tag, count }) => (
            <button 
              class="tag-btn" 
              data-tag={tag}
              style={`font-size: ${getTagSize(count)}rem`}
              title={`${count} posts`}
            >
              {tag}
            </button>
          ))}
        </div>
      </div>
    </div>

    <div class="post-list">
      {posts.map((post: any) => (
        <div class="post-wrapper" data-tags={post.tags ? post.tags.join(',') : ''}>
          <PostCard {...post} />
        </div>
      ))}
    </div>
  </div>
</PageLayout>

<script>
  const tagBtns = document.querySelectorAll('.tag-btn');
  const posts = document.querySelectorAll('.post-wrapper');

  tagBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tagBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const selectedTag = (btn as HTMLElement).dataset.tag;
      
      posts.forEach(post => {
        const tags = (post as HTMLElement).dataset.tags?.split(',') || [];
        if (!selectedTag || tags.includes(selectedTag)) {
          (post as HTMLElement).style.display = 'block';
        } else {
          (post as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  .page-container { max-width: 720px; margin: 0 auto; }
  .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .page-desc { color: #666; margin-bottom: 2rem; }
  
  .filter-container { 
    display: flex; 
    align-items: stretch; 
    margin-bottom: 2rem;
    min-height: 200px;
  }
  .filter-left {
    flex: 1;
  }
  .filter-separator {
    width: 1px;
    background-color: #eaeaea;
    margin: 0 1.5rem;
  }
  .filter-right {
    flex: 1;
  }
  .tags-box {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-content: flex-start;
    align-items: center;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  .tag-btn {
    padding: 0.4em 0.8em;
    border: 1px solid transparent;
    border-radius: 2em;
    background-color: #f5f5f5;
    color: #555;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1;
  }
  .tag-btn:hover {
    background-color: #e0e0e0;
    color: #000;
    transform: translateY(-1px);
  }
  .tag-btn.active {
    background-color: #000;
    color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .post-list { display: flex; flex-direction: column; gap: 1rem; }
</style>
