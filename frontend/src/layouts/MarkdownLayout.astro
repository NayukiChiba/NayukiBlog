---
import Header from "../components/Header.astro";
import FloatingButton from "../components/FloatingButton.astro";
const { frontmatter } = Astro.props;
const date = new Date(frontmatter.date);
const formattedDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{frontmatter.title}</title>
    <!-- KaTeX CSS - 使用本地资源 -->
    <link rel="stylesheet" href="/lib/katex/katex.min.css" />
    <!-- KaTeX 自动渲染扩展 - 处理遗漏的 LaTeX 公式 -->
    <script defer src="/lib/katex/katex.min.js"></script>
    <script defer src="/lib/katex/auto-render.min.js"></script>
    <!-- Mermaid 支持 -->
    <script defer src="/lib/mermaid/mermaid.min.js"></script>
  </head>
  <body>
    <Header />
    <main class="markdown-container page-enter">
      <article class="content">
        <header class="post-header">
          <div class="meta">
            <span class="date">{formattedDate}</span>
          </div>
          <h1>{frontmatter.title}</h1>
          {
            frontmatter.description && (
              <div class="description-card">
                <span class="description-label">简介</span>
                <div
                  class="description-content"
                  data-text={frontmatter.description}
                />
              </div>
            )
          }
          {
            frontmatter.tags && (
              <div class="tags">
                {frontmatter.tags.map((tag: any) => {
                  const cleanTag = String(tag).replace(/[\[\]"']/g, "");
                  return <span class="tag">{cleanTag}</span>;
                })}
              </div>
            )
          }
        </header>
        <hr />
        <slot />
      </article>
    </main>

    <!-- 桌面端固定目录 -->
    <aside class="toc-sidebar desktop-only">
      <div class="toc-sticky">
        <div class="toc-header" id="toc-header-clickable">
          <span>文章目录</span>
          <button
            id="toc-toggle"
            class="toc-toggle"
            aria-label="Toggle Table of Contents"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><polyline points="6 9 12 15 18 9"></polyline></svg
            >
          </button>
        </div>
        <nav id="article-toc"></nav>
      </div>
    </aside>

    <!-- 移动端目录悬浮按钮 -->
    <button
      class="mobile-toc-btn mobile-only"
      id="toc-float-btn"
      aria-label="文章目录"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </button>

    <!-- 移动端目录抽屉 -->
    <div class="mobile-toc-overlay" id="toc-overlay"></div>
    <div class="mobile-toc-drawer" id="toc-drawer">
      <div class="drawer-header">
        <span class="drawer-title">文章目录</span>
        <button class="drawer-close" id="toc-drawer-close" aria-label="关闭">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="drawer-content" id="mobile-toc"></nav>
    </div>

    <!-- Copy Toast Notification -->
    <div id="copy-toast" class="toast">
      <span class="dot"></span>
      <span class="message">已复制到剪贴板</span>
    </div>

    <!-- 图片预览灯箱 -->
    <div id="image-lightbox" class="lightbox">
      <div class="lightbox-overlay"></div>
      <div class="lightbox-content">
        <button class="lightbox-close" aria-label="关闭">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <img id="lightbox-image" src="" alt="" />
      </div>
    </div>

    <script>
      // 声明全局类型
      declare const renderMathInElement: any;
      declare const mermaid: any;

      // 初始化 Mermaid
      document.addEventListener("DOMContentLoaded", () => {
        // KaTeX 自动渲染 - 处理遗漏的 LaTeX 公式
        if (typeof renderMathInElement !== "undefined") {
          renderMathInElement(document.body, {
            delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "$", right: "$", display: false },
              { left: "\\(", right: "\\)", display: false },
              { left: "\\[", right: "\\]", display: true },
            ],
            throwOnError: false,
            ignoredTags: [
              "script",
              "noscript",
              "style",
              "textarea",
              "pre",
              "code",
            ],
            ignoredClasses: ["katex", "katex-display"], // 跳过已经渲染的公式
            displayMode: true, // 块级公式使用 display 模式
            trust: true,
          });
        }

        // Mermaid 初始化配置
        if (typeof mermaid !== "undefined") {
          mermaid.initialize({
            startOnLoad: false,
            theme: "default",
            securityLevel: "loose",
            fontFamily:
              '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
          });

          // 查找所有 mermaid 代码块并渲染
          // Shiki 可能生成: pre.astro-code.language-mermaid 或其他格式
          const mermaidSelectors = [
            "pre > code.language-mermaid",
            "pre.language-mermaid code",
            "pre.astro-code.language-mermaid code",
            'pre[data-language="mermaid"] code',
            ".astro-code code.language-mermaid",
          ];

          const mermaidBlocks = document.querySelectorAll(
            mermaidSelectors.join(", ")
          );

          // 如果没找到，尝试通过 pre 的 class 包含 mermaid 来查找
          let blocks = Array.from(mermaidBlocks);
          if (blocks.length === 0) {
            const allPres = document.querySelectorAll("pre.astro-code");
            allPres.forEach((pre) => {
              if (pre.className.includes("mermaid")) {
                const code = pre.querySelector("code");
                if (code) blocks.push(code);
              }
            });
          }

          blocks.forEach((block, index) => {
            const pre = block.parentElement;
            const code = block.textContent || "";

            // 创建 mermaid 容器
            const container = document.createElement("div");
            container.className = "mermaid";
            container.id = `mermaid-${index}`;
            container.textContent = code;

            // 替换 pre 元素
            pre?.parentNode?.replaceChild(container, pre);
          });

          // 运行 mermaid 渲染
          mermaid.run();
        }

        // TOC Toggle Logic
        const tocHeader = document.getElementById("toc-header-clickable");
        const tocToggle = document.getElementById("toc-toggle");
        const tocNav = document.getElementById("article-toc");

        if (tocHeader && tocToggle && tocNav) {
          const toggleToc = () => {
            tocNav.classList.toggle("collapsed");
            tocToggle.classList.toggle("collapsed");
          };

          tocHeader.addEventListener("click", toggleToc);
        }

        const toast = document.getElementById("copy-toast");
        let timeout: any;

        function showToast() {
          if (!toast) return;
          toast.classList.add("show");
          if (timeout) clearTimeout(timeout);
          timeout = setTimeout(() => {
            toast.classList.remove("show");
          }, 2000);
        }

        // 处理 Shiki 代码块：添加包装器、语言标签和复制按钮
        const codeBlocks = document.querySelectorAll("pre.astro-code");
        codeBlocks.forEach((pre) => {
          // 1. 创建 Wrapper
          const wrapper = document.createElement("div");
          wrapper.className = "code-wrapper";
          pre.parentNode?.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);

          // 2. 获取语言
          // Astro Shiki 通常在 pre 上添加 class="astro-code github-light language-js"
          // 或者在 code 上
          let lang = "";
          const classes = pre.className.split(" ");
          const langClass = classes.find((c) => c.startsWith("language-"));
          if (langClass) {
            lang = langClass.replace("language-", "");
          } else {
            // 尝试从 code 标签获取
            const code = pre.querySelector("code");
            if (code) {
              const codeClasses = Array.from(code.classList);
              const codeLangClass = codeClasses.find((c) =>
                c.startsWith("language-")
              );
              if (codeLangClass) lang = codeLangClass.replace("language-", "");
            }
          }

          // 3. 添加语言标签
          if (lang) {
            const langLabel = document.createElement("span");
            langLabel.className = "code-lang";
            langLabel.textContent = lang;
            wrapper.appendChild(langLabel);
          }

          // 4. 添加复制按钮
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          // 使用 SVG 图标
          copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

          copyBtn.addEventListener("click", async () => {
            const code = pre.querySelector("code");
            if (code) {
              try {
                await navigator.clipboard.writeText(code.innerText);
                showToast();
              } catch (err) {
                console.error("Failed to copy:", err);
              }
            }
          });
          wrapper.appendChild(copyBtn);
        });

        // 处理表格：添加包装器以支持横向滚动
        const tables = document.querySelectorAll(".content table");
        tables.forEach((table) => {
          const wrapper = document.createElement("div");
          wrapper.className = "table-wrapper";
          table.parentNode?.insertBefore(wrapper, table);
          wrapper.appendChild(table);
        });

        // 图片点击预览功能
        const lightbox = document.getElementById("image-lightbox");
        const lightboxImg = document.getElementById(
          "lightbox-image"
        ) as HTMLImageElement;
        const lightboxClose = document.querySelector(".lightbox-close");
        const lightboxOverlay = document.querySelector(".lightbox-overlay");
        const contentImages = document.querySelectorAll(".content img");

        contentImages.forEach((img) => {
          const imgElement = img as HTMLImageElement;
          // 添加点击事件
          imgElement.style.cursor = "pointer";
          imgElement.addEventListener("click", () => {
            if (lightbox && lightboxImg) {
              lightboxImg.src = imgElement.src;
              lightboxImg.alt = imgElement.alt;
              lightbox.classList.add("active");
              document.body.style.overflow = "hidden";
            }
          });
        });

        // 关闭灯箱
        const closeLightbox = () => {
          if (lightbox) {
            lightbox.classList.remove("active");
            document.body.style.overflow = "";
          }
        };

        lightboxClose?.addEventListener("click", closeLightbox);
        lightboxOverlay?.addEventListener("click", closeLightbox);

        // ESC键关闭
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && lightbox?.classList.contains("active")) {
            closeLightbox();
          }
        });

        // 3. 简介打字机效果
        const card = document.querySelector(".description-card");
        if (card) {
          const content = card.querySelector(".description-content");
          if (content) {
            const text = content.getAttribute("data-text") || "";

            // 清空内容准备打字
            (content as HTMLElement).innerText = "";

            let i = 0;
            function typeWriter() {
              if (i < text.length) {
                content!.innerHTML += text.charAt(i);
                i++;
                setTimeout(typeWriter, 20); // 打字速度
              }
            }
            // 稍微延迟一点开始，让页面先渲染出来
            setTimeout(typeWriter, 300);
          }
        }

        // 4. 自动生成目录 (TOC) 与 滚动监听
        const tocContainer = document.getElementById("article-toc");
        const mobileTocContainer = document.getElementById("mobile-toc");
        const contentEl = document.querySelector(".content");

        // 移动端目录抽屉逻辑
        const tocFloatBtn = document.getElementById("toc-float-btn");
        const tocDrawer = document.getElementById("toc-drawer");
        const tocOverlay = document.getElementById("toc-overlay");
        const tocDrawerClose = document.getElementById("toc-drawer-close");

        // 确保初始状态关闭
        tocDrawer?.classList.remove("open");
        tocOverlay?.classList.remove("visible");

        function openTocDrawer() {
          tocDrawer?.classList.add("open");
          tocOverlay?.classList.add("visible");
          document.body.style.overflow = "hidden";
        }

        function closeTocDrawer() {
          tocDrawer?.classList.remove("open");
          tocOverlay?.classList.remove("visible");
          document.body.style.overflow = "";
        }

        tocFloatBtn?.addEventListener("click", openTocDrawer);
        tocDrawerClose?.addEventListener("click", closeTocDrawer);
        tocOverlay?.addEventListener("click", closeTocDrawer);

        if ((tocContainer || mobileTocContainer) && contentEl) {
          // 获取所有标题
          const headings = contentEl.querySelectorAll("h1, h2, h3, h4");

          if (headings.length > 0) {
            // 为桌面端和移动端都生成目录
            const createTocList = (forMobile = false) => {
              const ul = document.createElement("ul");

              headings.forEach((heading, index) => {
                // 确保标题有 ID
                if (!heading.id) {
                  heading.id = "heading-" + index;
                }

                const li = document.createElement("li");
                const level = parseInt(heading.tagName.substring(1));
                li.className = `toc-item level-${level}`;
                li.dataset.level = level.toString();

                const div = document.createElement("div");
                div.className = "toc-item-container";

                const a = document.createElement("a");
                a.href = "#" + heading.id;
                a.textContent = heading.textContent;

                a.addEventListener("click", (e) => {
                  e.preventDefault();
                  heading.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                  history.pushState(null, "", "#" + heading.id);
                  // 如果是移动端，关闭抽屉
                  if (forMobile) {
                    closeTocDrawer();
                  }
                });

                div.appendChild(a);
                li.appendChild(div);
                ul.appendChild(li);
              });

              return ul;
            };

            // 桌面端目录
            if (tocContainer) {
              tocContainer.appendChild(createTocList(false));

              // 添加折叠功能（仅桌面端）
              const tocItems = tocContainer.querySelectorAll(".toc-item");
              tocItems.forEach((item, index) => {
                const currentLevel = parseInt(
                  (item as HTMLElement).dataset.level || "0"
                );
                const nextItem = tocItems[index + 1] as HTMLElement;

                if (nextItem) {
                  const nextLevel = parseInt(nextItem.dataset.level || "0");
                  if (nextLevel > currentLevel) {
                    const btn = document.createElement("span");
                    btn.className = "toc-collapse-btn";
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

                    const container = item.querySelector(".toc-item-container");
                    if (container) {
                      container.appendChild(btn);
                      item.classList.add("has-children");
                    }

                    btn.addEventListener("click", (e) => {
                      e.stopPropagation();
                      btn.classList.toggle("collapsed");
                      const isCollapsed = btn.classList.contains("collapsed");

                      for (let i = index + 1; i < tocItems.length; i++) {
                        const sibling = tocItems[i] as HTMLElement;
                        const siblingLevel = parseInt(
                          sibling.dataset.level || "0"
                        );

                        if (siblingLevel <= currentLevel) break;

                        if (isCollapsed) {
                          sibling.classList.add("hidden-by-parent");
                        } else {
                          sibling.classList.remove("hidden-by-parent");
                        }
                      }
                    });
                  }
                }
              });
            }

            // 移动端目录
            if (mobileTocContainer) {
              mobileTocContainer.appendChild(createTocList(true));
            }

            // 滚动监听 (Intersection Observer)
            const observerOptions = {
              root: null,
              rootMargin: "-100px 0px -70% 0px",
              threshold: 0,
            };

            const observer = new IntersectionObserver((entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  document
                    .querySelectorAll(".toc-item a")
                    .forEach((link) => link.classList.remove("active"));

                  const id = entry.target.id;
                  const activeLinks = document.querySelectorAll(
                    `.toc-item a[href="#${id}"]`
                  );
                  activeLinks.forEach((activeLink) => {
                    activeLink.classList.add("active");
                  });
                }
              });
            }, observerOptions);

            headings.forEach((h) => observer.observe(h));
          } else {
            // 如果没有标题，隐藏目录栏和移动端按钮
            const sidebar = document.querySelector(".toc-sidebar");
            const mobileBtn = document.querySelector(".mobile-toc-btn");
            if (sidebar) (sidebar as HTMLElement).style.display = "none";
            if (mobileBtn) (mobileBtn as HTMLElement).style.display = "none";
          }
        }
      });
    </script>
    <FloatingButton />
  </body>
</html>

<style is:global>
  :root {
    --bg-color: #ffffff;
    --text-color: #000000;
    --primary-color: #3498db;
    --code-bg: #f6f8fa;
    --border-color: #eaecef;
    /* 增大文章宽度，让布局更宽阔 */
    --max-width: 950px;
    --content-padding: 1rem;
  }

  /* Code Block Styles (Shiki) */
  .code-wrapper {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 8px;
    background-color: var(--code-bg);
  }

  /* 覆盖 Shiki 默认背景，确保统一 */
  pre.astro-code {
    background-color: var(--code-bg) !important;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0; /* 由 wrapper 控制 margin */
    border: none; /* 无边框 */
    box-shadow: none; /* 无阴影 */
  }

  pre.astro-code code {
    background-color: transparent;
    padding: 0;
    font-size: 0.9rem;
    color: inherit;
    font-family:
      "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
  }

  /* 语言标签 */
  .code-lang {
    position: absolute;
    top: 0.5rem;
    right: 2.5rem;
    font-size: 0.75rem;
    color: #888;
    font-weight: 600;
    text-transform: uppercase;
    user-select: none;
    pointer-events: none;
  }

  /* 复制按钮 */
  .copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      color 0.2s,
      background-color 0.2s;
  }

  .copy-btn:hover {
    color: #333;
    background-color: rgba(0, 0, 0, 0.05);
  }

  /* 代码语言标识样式 - 旧的移除，使用上面的 .code-lang */

  body {
    margin: 0;
    overflow-x: hidden;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family:
      -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
      sans-serif;
    line-height: 1.7;
  }

  html {
    scrollbar-gutter: stable;
    overflow-x: hidden;
  }

  @media (max-width: 1399px) {
    html {
      scrollbar-gutter: auto;
    }
  }

  .markdown-container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* 文章内容居中 */
  .content {
    max-width: var(--max-width);
    margin: 0 auto;
    margin-bottom: 4rem;
  }

  /* 桌面端：去掉偏移，让文章居中 */
  @media (min-width: 1400px) {
    .markdown-container {
      margin-right: auto;
    }
  }

  /* 桌面端/移动端显示控制 */
  .desktop-only {
    display: none;
  }

  .mobile-only {
    display: none;
  }

  @media (min-width: 1400px) {
    .desktop-only {
      display: block;
    }
  }

  @media (max-width: 1399px) {
    .mobile-only {
      display: flex;
    }
  }

  /* 侧边栏样式 - Fixed 定位在屏幕右侧 */
  .toc-sidebar {
    position: fixed;
    top: 100px;
    width: 200px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    z-index: 50;
  }

  /* 大屏幕：目录在内容右侧，距离内容有间距 */
  @media (min-width: 1400px) {
    .toc-sidebar {
      left: calc(50% + var(--max-width) / 2 + 1.5rem);
    }
  }

  /* ====== 移动端目录悬浮按钮和抽屉样式 ====== */
  @media (max-width: 1399px) {
    .mobile-toc-btn {
      position: fixed;
      top: 5rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .mobile-toc-btn:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: scale(1.05);
    }

    .mobile-toc-btn svg {
      width: 24px;
      height: 24px;
      color: #666;
    }
  }

  .mobile-toc-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  /* 桌面端隐藏移动端目录组件 */
  @media (min-width: 1400px) {
    .mobile-toc-overlay,
    .mobile-toc-drawer {
      display: none !important;
    }
  }

  .mobile-toc-overlay.visible {
    opacity: 1;
    visibility: visible;
  }

  .mobile-toc-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: 280px;
    max-width: 80vw;
    height: 100vh;
    background: white;
    z-index: 201;
    transform: translateX(100%);
    transition:
      transform 0.3s ease,
      visibility 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    visibility: hidden;
  }

  .mobile-toc-drawer.open {
    transform: translateX(0);
    visibility: visible;
  }

  .drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
  }

  .drawer-title {
    font-weight: 600;
    font-size: 1rem;
    color: #333;
  }

  .drawer-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: color 0.2s;
  }

  .drawer-close:hover {
    color: #333;
  }

  .drawer-close svg {
    width: 20px;
    height: 20px;
  }

  .drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  /* 移动端目录样式 */
  #mobile-toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #mobile-toc li {
    margin: 0;
    line-height: 1;
  }

  #mobile-toc a {
    text-decoration: none;
    color: #666;
    font-size: 0.9rem;
    display: block;
    padding: 0.75rem 1rem;
    border-left: 2px solid var(--border-color);
    transition: all 0.2s;
  }

  #mobile-toc a:hover {
    color: #000;
    border-left-color: #000;
    background: #f5f5f5;
  }

  #mobile-toc a.active {
    color: #000;
    font-weight: 600;
    border-left-color: #000;
    background: #f0f0f0;
  }

  /* 移动端目录层级缩进 */
  #mobile-toc .level-1 a {
    padding-left: 1rem;
  }
  #mobile-toc .level-2 a {
    padding-left: 2rem;
  }
  #mobile-toc .level-3 a {
    padding-left: 3rem;
    font-size: 0.85rem;
  }
  #mobile-toc .level-4 a {
    padding-left: 4rem;
    font-size: 0.85rem;
  }

  .toc-sticky {
    /* 不再需要 position 定位，由父元素 .toc-sidebar 控制 */
    width: 100%;
  }

  .toc-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding-left: 1rem; /* 对齐链接 */
    padding-right: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }

  .toc-toggle {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    transition: transform 0.3s ease;
  }

  .toc-toggle.collapsed {
    transform: rotate(-90deg);
  }

  #article-toc {
    transition:
      max-height 0.3s ease,
      opacity 0.3s ease;
    max-height: calc(100vh - 180px); /* 限制最大高度，留出 header 和标题空间 */
    opacity: 1;
    overflow-y: auto; /* 允许垂直滚动 */
    overflow-x: hidden; /* 隐藏水平滚动 */
  }

  #article-toc.collapsed {
    max-height: 0;
    opacity: 0;
    overflow: hidden; /* 折叠时隐藏所有溢出内容 */
  }

  /* 目录滚动条美化 */
  #article-toc::-webkit-scrollbar {
    width: 4px;
  }
  #article-toc::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 4px;
  }
  #article-toc:hover::-webkit-scrollbar-thumb {
    background-color: #ccc;
  }

  #article-toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #article-toc li {
    margin: 0;
    line-height: 1;
  }

  /* 仿照 Astro Pure 风格：左侧线条 + 缩进 */
  #article-toc a {
    text-decoration: none;
    color: #888;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: block;
    border-left: 2px solid var(--border-color); /* 默认线条颜色 */
    padding: 0.5rem 0 0.5rem 1rem;
    line-height: 1.4;
    overflow: hidden; /* 隐藏溢出内容 */
    text-overflow: ellipsis; /* 显示省略号 */
    white-space: nowrap; /* 不换行 */
  }

  #article-toc a:hover {
    color: #000;
    border-left-color: #000;
  }

  #article-toc a.active {
    color: #000;
    font-weight: 600;
    border-left-color: #000; /* 激活时线条变色 */
    background: none; /* 移除背景 */
  }

  /* 新增：TOC 容器布局 */
  .toc-item-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  /* 新增：折叠按钮样式 */
  .toc-collapse-btn {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #999;
    transition: transform 0.2s ease;
    z-index: 2;
    margin-left: auto; /* 推到最右侧 */
    padding-right: 0.5rem; /* 右侧留白 */
  }

  .toc-collapse-btn:hover {
    color: #333;
  }

  .toc-collapse-btn.collapsed {
    transform: rotate(-90deg);
  }

  /* 隐藏状态 */
  .toc-item.hidden-by-parent {
    display: none;
  }

  /* 调整链接样式以适应按钮 */
  #article-toc a {
    flex: 1;
    min-width: 0; /* 允许链接收缩 */
    /* 保持原有的 padding 和 border */
  }

  /* 目录层级缩进：恢复纯粹的缩进，不再为左侧按钮留空 */
  /* Level 1 */
  .toc-item.level-1 a {
    padding-left: 1rem;
  }

  /* Level 2 */
  .toc-item.level-2 a {
    padding-left: 2rem;
  }

  /* Level 3 */
  .toc-item.level-3 a {
    padding-left: 3rem;
    font-size: 0.8rem;
  }

  /* Level 4 */
  .toc-item.level-4 a {
    padding-left: 4rem;
    font-size: 0.8rem;
  }

  /* 滚动条美化 - 改为 toc-sidebar */
  .toc-sidebar::-webkit-scrollbar {
    width: 4px;
  }
  .toc-sidebar::-webkit-scrollbar-thumb {
    background-color: #eee;
    border-radius: 4px;
  }
  .toc-sidebar:hover::-webkit-scrollbar-thumb {
    background-color: #ccc;
  }

  /* Toast Styles */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: white;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 0.8rem;
    z-index: 1000;
    transition: all 0.3s ease;
    opacity: 0;
    pointer-events: none;
    border: 1px solid var(--border-color);
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast .dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary-color);
    border-radius: 50%;
    transition: all 0.3s ease;
    position: relative;
  }

  /* 简介卡片样式 - 修复选择器 */
  .description-card {
    margin-bottom: 1rem;
    font-size: 0.95rem;
    width: 100%;
    background-color: #f8f9fa;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    position: relative;
  }

  /* 装饰性引号 */
  .description-card::after {
    content: "”";
    font-family: serif;
    font-size: 6rem;
    color: var(--primary-color);
    opacity: 0.1;
    position: absolute;
    bottom: -1rem;
    right: 1rem;
    line-height: 1;
    pointer-events: none;
  }

  .description-label {
    font-weight: 600;
    color: #000;
    margin-right: 0.8rem;
    padding-right: 0.8rem;
    border-right: 2px solid #e1e4e8;
    float: left;
    user-select: none;
    line-height: 1.6;
  }

  .description-content {
    display: inline;
    line-height: 1.6;
    color: #1a1a1a;
  }

  /* 恢复丢失的 Meta 和 Tag 样式 */
  .meta {
    margin-bottom: 0.5rem;
  }

  .meta .date {
    display: inline-block;
    font-size: 0.8rem;
    color: #999;
    font-weight: 500;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .tags {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    font-size: 0.75rem;
    color: #555;
    background: rgba(0, 0, 0, 0.05);
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    transition: background 0.2s;
    font-style: normal;
    font-weight: normal;
    font-family: inherit;
  }

  .tag:hover {
    background: rgba(0, 0, 0, 0.08);
  }

  /* Markdown Content Styles */
  .content h1,
  .content h2,
  .content h3,
  .content h4 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #000000;
    font-weight: 600;
  }

  .content h2 {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.3rem;
  }

  .content p {
    margin-bottom: 1.2rem;
  }

  /* 图片样式 - 限制最大宽度防止溢出 */
  .content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5rem auto;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .content strong,
  .content b {
    color: #000000;
  }
  .content strong,
  .content b {
    color: #000000;
  }
  /* 2. 链接样式优化 */
  .content a {
    color: #000000;
    text-decoration: none;
    font-weight: 500;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
  }
  .content a:hover {
    border-bottom-color: #000;
  }
  .content a strong {
    color: #000;
    font-weight: 700;
  }

  /* 3. 列表样式优化 */
  .content ul,
  .content ol {
    padding-left: 1.5rem;
    margin: 1rem 0;
    color: #444;
  }

  .content li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
    position: relative;
  }

  .content ul li::marker {
    color: #888;
  }

  .content ol li::marker {
    color: #888;
    font-weight: 500;
  }

  /* 任务列表样式 */
  .content ul li input[type="checkbox"] {
    margin-right: 0.5rem;
  }

  .content ul li:has(input[type="checkbox"]) {
    list-style: none;
    margin-left: -1.5rem; /* 抵消 ul 的 padding */
  }

  /* 4. 引用卡片化 + 内部样式 */
  .content blockquote {
    margin: 2rem 0;
    padding: 2rem;
    border: none;
    background-color: #f8f9fa;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* 突出外层阴影 */
    color: #000000;
    font-style: normal; /* 不使用斜体 */
    font-weight: 500;
    position: relative;
    overflow: hidden;
  }

  .content blockquote p {
    margin: 0;
    position: relative;
    z-index: 1;
  }

  .content blockquote p:not(:last-child) {
    margin-bottom: 1rem;
  }

  /* 左侧装饰条 */
  .content blockquote::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(
      180deg,
      var(--primary-color) 0%,
      rgba(0, 0, 0, 0.2) 100%
    );
    border-radius: 4px 0 0 4px;
  }

  .content code {
    background-color: rgba(27, 31, 35, 0.05);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family:
      "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 85%;
  }

  /* Expressive Code handles pre/code blocks */
  .content pre {
    margin: 1.5rem 0;
    border: 1px solid var(--border-color); /* 加上淡边框 */
  }

  /* 4. 表格样式调整：添加包装器支持移动端滚动 */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    margin: 1.5rem 0;
    -webkit-overflow-scrolling: touch; /* iOS 滚动优化 */
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .content table {
    display: table !important; /* 明确指定为表格布局 */
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    margin: 0; /* 由 table-wrapper 统一管理 margin */
    border: none;
    box-shadow: none;
    table-layout: auto; /* 允许表格自动调整列宽 */
  }

  /* 确保表格内部元素使用正确的display */
  .content thead,
  .content tbody {
    display: table-header-group !important;
  }

  .content tbody {
    display: table-row-group !important;
  }

  .content tr {
    display: table-row !important;
  }

  @media (min-width: 1024px) {
    .table-wrapper {
      box-shadow: none; /* 桌面端不需要阴影 */
    }
  }

  .content th,
  .content td {
    display: table-cell !important; /* 明确指定为表格单元格 */
    padding: 0.8rem 1rem;
    border: 1px solid var(--border-color);
  }

  /* 避免双重边框 */
  .content th:not(:first-child),
  .content td:not(:first-child) {
    border-left: none;
  }

  .content tr:not(:first-child) th,
  .content tr:not(:first-child) td {
    border-top: none;
  }

  .content th {
    background-color: #f6f8fa;
    font-weight: 600;
    text-align: left;
  }

  /* 保持表头圆角 */
  .content tr:first-child th:first-child {
    border-top-left-radius: 16px;
  }
  .content tr:first-child th:last-child {
    border-top-right-radius: 16px;
  }

  /* 文章底部边距 */
  .content {
    margin-bottom: 4rem;
  }

  /* KaTeX 公式样式优化 */
  .katex-display {
    overflow-x: auto;
    overflow-y: hidden;
    padding: 1.5rem 0;
    margin: 2rem auto;
    text-align: center;
    background-color: transparent;
    display: block;
    width: 100%;
  }

  /* 确保块级公式容器居中 */
  .katex-display > .katex {
    display: inline-block;
    text-align: center;
  }

  /* 块级公式使用更大的字体和正确的 displaystyle */
  .katex-display > .katex > .katex-html {
    display: block;
    text-align: center;
  }

  /* 让行内公式稍微大一点，更清晰 */
  .katex {
    font-size: 1.1em;
  }

  /* 块级公式字体更大 */
  .katex-display .katex {
    font-size: 1.21em;
  }

  /* 修复 KaTeX 在某些情况下的字体显示问题 */
  .katex .base {
    margin-top: 2px;
  }

  /* 确保 displaystyle 的求和、积分等符号正确显示 */
  .katex-display .katex .mop {
    /* 确保大运算符正确显示 */
  }

  /* 段落中的块级公式居中 */
  p > .katex-display,
  .content > .katex-display {
    margin-left: auto;
    margin-right: auto;
  }

  /* HTML 居中元素支持 */
  .content center,
  .content [align="center"],
  .content [style*="text-align: center"],
  .content [style*="text-align:center"] {
    text-align: center;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* 确保居中元素内的图片也居中 */
  .content center img,
  .content [align="center"] img,
  .content [style*="text-align: center"] img,
  .content [style*="text-align:center"] img {
    margin-left: auto;
    margin-right: auto;
  }

  /* Mermaid 图表样式 */
  .mermaid {
    display: flex;
    justify-content: center;
    margin: 2rem 0;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
  }

  .mermaid svg {
    max-width: 100%;
    height: auto;
  }

  /* 图片灯箱样式 */
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .lightbox-content {
    position: relative;
    z-index: 10000;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
  }

  .lightbox-close {
    position: absolute;
    top: -3rem;
    right: 0;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10001;
  }

  .lightbox-close:hover {
    background: white;
    transform: scale(1.1);
  }

  .lightbox-close svg {
    color: #333;
  }

  /* 移动端调整 */
  @media (max-width: 768px) {
    .lightbox-close {
      top: 1rem;
      right: 1rem;
    }
  }
</style>
