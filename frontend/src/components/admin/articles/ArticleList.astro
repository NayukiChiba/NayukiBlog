---
---
<div class="article-list-card">
    <div class="card-header">
        <span>Article List</span>
        <span class="count" id="article-count">0 articles</span>
    </div>
    <div class="table-container">
        <table class="article-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Slug</th>
                    <th>Category</th>
                    <th>Tags</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="article-table-body">
                <!-- Rows will be populated by JS -->
                <tr><td colspan="7" class="loading-text">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination">
        <!-- Pagination buttons -->
    </div>
</div>

<script>
    interface Article {
        id: string;
        title: string;
        slug?: string;
        url?: string;
        category?: string;
        folder?: string;
        tags?: string[];
        status?: string;
        date?: string;
    }

    let allArticles: Article[] = [];
    let filteredArticles: Article[] = [];
    let currentPage = 1;
    const pageSize = 10;
    let currentFilters = {
        title: '',
        category: '',
        tags: [],
        status: ''
    };

    const API_BASE = 'http://127.0.0.1:8000';

    async function fetchArticles() {
        const tbody = document.getElementById('article-table-body');
        if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="loading-text">Loading...</td></tr>';

        try {
            // Fetch articles, categories, and tags in parallel
            const [articlesRes, categoriesRes, tagsRes] = await Promise.all([
                fetch(`${API_BASE}/api/admin/articles`),
                fetch(`${API_BASE}/api/articles/categories`),
                fetch(`${API_BASE}/api/articles/tags`)
            ]);

            if (!articlesRes.ok) throw new Error('Failed to fetch articles');
            allArticles = await articlesRes.json();

            let categories = [];
            if (categoriesRes.ok) {
                const data = await categoriesRes.json();
                categories = data.categories || [];
            }

            let tags = [];
            if (tagsRes.ok) {
                const data = await tagsRes.json();
                tags = data.tags || [];
            }

            // Broadcast data to other components
            document.dispatchEvent(new CustomEvent('articles-data-loaded', { 
                detail: { categories, tags } 
            }));

            applyFilters();
        } catch (error) {
            console.error(error);
            if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="error-text">Failed to load articles.</td></tr>';
        }
    }

    function applyFilters() {
        filteredArticles = allArticles.filter(article => {
            const matchTitle = !currentFilters.title || article.title.toLowerCase().includes(currentFilters.title.toLowerCase());
            const cat = article.folder || article.category;
            const matchCategory = !currentFilters.category || cat === currentFilters.category || cat?.startsWith(currentFilters.category + '/');
            const matchStatus = !currentFilters.status || (article.status || 'published') === currentFilters.status;
            // Fix: Handle undefined tags safely
            const matchTags = !currentFilters.tags.length || currentFilters.tags.every(tag => (article.tags || []).includes(tag));
            return matchTitle && matchCategory && matchStatus && matchTags;
        });
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('article-table-body');
        const countSpan = document.getElementById('article-count');
        const pagination = document.getElementById('pagination');
        
        if (!tbody) return;

        if (countSpan) countSpan.textContent = `${filteredArticles.length} articles`;

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = filteredArticles.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-text">No articles found</td></tr>';
            if(pagination) pagination.innerHTML = '';
            return;
        }

        tbody.innerHTML = pageData.map(article => `
            <tr>
                <td><div class="title" title="${article.title}">${article.title}</div></td>
                <td><div class="slug">${article.url || article.slug || ''}</div></td>
                <td><span class="category">${article.folder || article.category || 'Uncategorized'}</span></td>
                <td>
                    <div class="tags">
                        ${(article.tags || []).slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        ${(article.tags || []).length > 3 ? `<span class="more-tags">+${(article.tags || []).length - 3}</span>` : ''}
                    </div>
                </td>
                <td>
                    <select class="status-select" data-id="${article.id}" onchange="updateStatus('${article.id}', this.value)">
                        <option value="draft" ${article.status === 'draft' ? 'selected' : ''}>Draft</option>
                        <option value="published" ${(!article.status || article.status === 'published') ? 'selected' : ''}>Published</option>
                        <option value="recycled" ${article.status === 'recycled' ? 'selected' : ''}>Recycled</option>
                    </select>
                </td>
                <td>${article.date ? new Date(article.date).toLocaleDateString() : ''}</td>
                <td>
                    <div class="actions">
                        <button class="btn-icon edit" onclick="editArticle('${article.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete" onclick="deleteArticle('${article.id}')"><i class="fas fa-trash"></i></button>
                        ${(!article.status || article.status === 'published') ? `<a href="/posts/${article.url}" target="_blank" class="btn-icon view"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </div>
                </td>
            </tr>
        `).join('');

        renderPagination();
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;

        const totalPages = Math.ceil(filteredArticles.length / pageSize);
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">&lt;</button>`;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span>...</span>`;
            }
        }
        html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">&gt;</button>`;
        pagination.innerHTML = html;
    }

    // Expose functions to global scope for inline event handlers
    declare global {
        interface Window {
            changePage: (page: number) => void;
            updateStatus: (id: string, status: string) => Promise<void>;
            deleteArticle: (id: string) => Promise<void>;
            editArticle: (id: string) => void;
        }
    }

    window.changePage = (page) => {
        currentPage = page;
        renderTable();
    };

    window.updateStatus = async (id, status) => {
        try {
            await fetch(`/api/admin/articles/${id}/status`, { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }) 
            });
            console.log(`Update status for ${id} to ${status}`);
            // Optimistic update
            const article = allArticles.find(a => a.id === id);
            if (article) article.status = status;
        } catch (e) {
            console.error(e);
            alert('Failed to update status');
        }
    };

    window.deleteArticle = async (id) => {
        if (!confirm('Are you sure you want to delete this article?')) return;
        try {
            await fetch(`${API_BASE}/api/admin/articles/${id}`, { method: 'DELETE' });
            console.log(`Delete article ${id}`);
            // Fix: Added missing parenthesis before 'a'
            allArticles = allArticles.filter(a => a.id !== id);
            applyFilters();
        } catch (e) {
            console.error(e);
            alert('Failed to delete article');
        }
    };

    window.editArticle = (id) => {
        console.log('Edit', id);
        // Dispatch event to open edit dialog
        // document.dispatchEvent(new CustomEvent('open-edit-modal', { detail: { id } }));
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        fetchArticles();

        document.addEventListener('refresh-articles', fetchArticles);
        document.addEventListener('article-uploaded', fetchArticles);

        document.addEventListener('filter-changed', (e) => {
            const detail = (e as CustomEvent).detail;
            currentFilters = { ...currentFilters, ...detail };
            applyFilters();
        });
    });
</script>

<style>
    .article-list-card {
        background: white;
        border: 1px solid #f0f0f0;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        overflow: hidden;
        margin-top: 1rem;
    }

    .card-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header span:first-child {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111;
        letter-spacing: -0.01em;
    }

    .count {
        color: #666;
        font-size: 0.8rem;
        font-weight: 600;
        background: #f5f5f5;
        padding: 4px 10px;
        border-radius: 100px;
    }

    .table-container {
        overflow-x: auto;
    }

    .article-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .article-table th {
        background: #fff;
        color: #999;
        font-weight: 600;
        text-align: left;
        padding: 1.2rem 2rem;
        border-bottom: 1px solid #f5f5f5;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .article-table td {
        padding: 1.2rem 2rem;
        border-bottom: 1px solid #f9f9f9;
        color: #444;
        vertical-align: middle;
        transition: background-color 0.2s;
    }

    .article-table tr:last-child td {
        border-bottom: none;
    }

    .article-table tr:hover td {
        background-color: #fafafa;
    }

    .title {
        font-weight: 600;
        color: #111;
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.95rem;
        letter-spacing: -0.01em;
    }

    .slug {
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        color: #999;
        font-size: 0.8rem;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .category {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 6px;
        font-size: 0.8rem;
        color: #555;
        font-weight: 500;
    }

    .tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .tag {
        background: #fff;
        border: 1px solid #eee;
        color: #666;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .more-tags {
        font-size: 0.75rem;
        color: #999;
        padding: 2px 4px;
    }

    /* Modern Select Styling */
    .status-select {
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid #eee;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        text-align: center;
        min-width: 100px;
        background-color: #fff;
        color: #333;
        /* Custom Arrow */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 24px; /* Space for arrow */
    }
    
    .status-select:hover {
        border-color: #ccc;
        background-color: #fafafa;
    }
    
    .status-select:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }

    /* Actions - Modern & Minimal */
    .actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transform: translateX(10px);
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .article-table tr:hover .actions {
        opacity: 1;
        transform: translateX(0);
    }

    .btn-icon {
        border: none;
        background: transparent;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        transition: all 0.2s;
        font-size: 0.9rem;
        border-radius: 8px;
    }

    .btn-icon:hover { 
        color: #000; 
        background: #f0f0f0;
        transform: translateY(-1px);
    }
    
    .btn-icon.delete:hover { 
        color: #ff4d4f; 
        background: rgba(255, 77, 79, 0.1);
    }

    .pagination {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        border-top: 1px solid #f5f5f5;
    }

    .pagination button {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #666;
        transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
        color: #000;
        background: #f5f5f5;
    }

    .pagination button.active {
        background: #000;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .pagination button:disabled {
        color: #eee;
        cursor: not-allowed;
    }
</style>
