---
// DiaryCreate.astro
---

<div class="create-card">
  <div class="card-header">
    <h3 class="card-title">New Diary Entry</h3>
  </div>
  
  <form id="create-diary-form" class="create-form">
    <div class="form-row">
      <div class="form-group date-group">
        <label>Time</label>
        <input type="datetime-local" name="date" required class="form-input" id="diary-date-input">
      </div>
      
      <div class="form-group mood-group">
        <label>Mood</label>
        <div class="custom-select-wrapper" id="moodSelectWrapper">
            <div class="custom-select-trigger" id="moodTrigger">
                <span class="current-text">Happy</span>
                <input type="hidden" name="mood" value="happy">
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="custom-options hidden" id="moodOptions">
                <div class="custom-option selected" data-value="happy">Happy</div>
                <div class="custom-option" data-value="neutral">Neutral</div>
                <div class="custom-option" data-value="sad">Sad</div>
                <div class="custom-option" data-value="excited">Excited</div>
                <div class="custom-option" data-value="tired">Tired</div>
                <div class="custom-option" data-value="angry">Angry</div>
            </div>
        </div>
      </div>

      <div class="form-group weather-group">
        <label>Weather</label>
        <div class="custom-select-wrapper" id="weatherSelectWrapper">
            <div class="custom-select-trigger" id="weatherTrigger">
                <span class="current-text">Sunny</span>
                <input type="hidden" name="weather" value="sunny">
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="custom-options hidden" id="weatherOptions">
                <div class="custom-option selected" data-value="sunny">Sunny</div>
                <div class="custom-option" data-value="cloudy">Cloudy</div>
                <div class="custom-option" data-value="rainy">Rainy</div>
                <div class="custom-option" data-value="snowy">Snowy</div>
                <div class="custom-option" data-value="windy">Windy</div>
            </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Content</label>
      <textarea name="content" rows="3" class="form-textarea" placeholder="Write about your day..."></textarea>
    </div>

    <div class="form-group">
      <label>Images (Max 2)</label>
      <div class="image-upload-row">
        <div class="image-upload-box" id="upload-box-1">
            <input type="file" accept="image/*" class="file-input" data-index="0">
            <div class="upload-placeholder">
                <i class="fas fa-plus"></i>
            </div>
            <div class="preview-container hidden">
                <img src="" alt="Preview" class="preview-img">
                <button type="button" class="remove-img-btn">&times;</button>
            </div>
        </div>
        <div class="image-upload-box" id="upload-box-2">
            <input type="file" accept="image/*" class="file-input" data-index="1">
            <div class="upload-placeholder">
                <i class="fas fa-plus"></i>
            </div>
            <div class="preview-container hidden">
                <img src="" alt="Preview" class="preview-img">
                <button type="button" class="remove-img-btn">&times;</button>
            </div>
        </div>
      </div>
    </div>

    <div class="form-footer">
      <button type="submit" class="btn-submit">
        <i class="fas fa-paper-plane"></i> Publish
      </button>
    </div>
  </form>
</div>

<style>
  .create-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    height: 100%; /* Match parent height if grid */
    box-sizing: border-box;
  }

  .card-header {
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #f5f5f5;
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-title::before {
    content: '';
    width: 4px;
    height: 16px;
    background: #000; /* Black accent for creation */
    border-radius: 2px;
  }

  .create-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    flex: 1;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .date-group { flex: 2; }
  .mood-group { flex: 1.5; }
  .weather-group { flex: 1.5; }

  label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .form-input, .form-textarea {
    padding: 0.6rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.2s;
    width: 100%;
    box-sizing: border-box;
  }

  .form-input:focus, .form-textarea:focus {
    border-color: #000;
    outline: none;
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  /* Custom Select Styles (Reused) */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0 0.6rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 38px; /* Match input height approx */
    font-size: 0.9rem;
    color: #333;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .custom-options.hidden { display: none; }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #444;
  }

  .custom-option:hover { background: #f5f5f7; }
  .custom-option.selected { background: #f0f7ff; color: #0066cc; }

  /* Image Upload */
  .image-upload-row {
    display: flex;
    gap: 1rem;
  }

  .image-upload-box {
    width: 80px;
    height: 80px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafafa;
  }

  .image-upload-box:hover {
    border-color: #999;
    background: #f0f0f0;
  }

  .file-input {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
  }

  .upload-placeholder {
    color: #ccc;
    font-size: 1.5rem;
    pointer-events: none;
  }

  .preview-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 6px;
    overflow: hidden;
    z-index: 1;
  }

  .preview-container.hidden { display: none; }

  .preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .remove-img-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 3;
  }

  .form-footer {
    margin-top: auto;
    display: flex;
    justify-content: flex-end;
  }

  .btn-submit {
    background: #000;
    color: white;
    border: none;
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.2s;
  }

  .btn-submit:hover {
    background: #333;
  }
</style>

<script>
  // Set default date to now
  const dateInput = document.getElementById('diary-date-input') as HTMLInputElement;
  if (dateInput) {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    dateInput.value = now.toISOString().slice(0, 16);
  }

  // Custom Select Logic
  function setupSelect(wrapperId: string) {
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) return;
    
    const trigger = wrapper.querySelector('.custom-select-trigger');
    const options = wrapper.querySelector('.custom-options');
    const input = wrapper.querySelector('input[type="hidden"]') as HTMLInputElement;
    const textSpan = wrapper.querySelector('.current-text');

    trigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other selects
        document.querySelectorAll('.custom-options').forEach(el => {
            if (el !== options) el.classList.add('hidden');
        });
        options?.classList.toggle('hidden');
    });

    options?.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains('custom-option')) {
            const value = target.getAttribute('data-value');
            const text = target.textContent;
            
            options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');
            
            if (textSpan) textSpan.textContent = text;
            if (input) input.value = value || '';
            
            options.classList.add('hidden');
        }
    });
  }

  setupSelect('moodSelectWrapper');
  setupSelect('weatherSelectWrapper');

  document.addEventListener('click', () => {
    document.querySelectorAll('.custom-options').forEach(el => el.classList.add('hidden'));
  });

  // Image Upload Logic
  const imageBoxes = document.querySelectorAll('.image-upload-box');
  imageBoxes.forEach(box => {
    const input = box.querySelector('.file-input') as HTMLInputElement;
    const previewContainer = box.querySelector('.preview-container');
    const previewImg = box.querySelector('.preview-img') as HTMLImageElement;
    const removeBtn = box.querySelector('.remove-img-btn');

    input.addEventListener('change', (e) => {
        const file = (e.target as HTMLInputElement).files?.[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (previewImg && e.target?.result) {
                    previewImg.src = e.target.result as string;
                    previewContainer?.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        }
    });

    removeBtn?.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent triggering file input
        input.value = '';
        previewImg.src = '';
        previewContainer?.classList.add('hidden');
    });
  });

  // Form Submission
  const form = document.getElementById('create-diary-form') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    // Handle images manually if needed, or let FormData handle it if backend expects 'file'
    // Assuming backend expects JSON for data and maybe separate upload for images, 
    // OR multipart/form-data. Let's assume multipart/form-data for simplicity if backend supports it.
    // If backend is JSON only, we need to upload images first or base64 them.
    // Given the context, let's try to construct a JSON payload first as per typical FastAPI + Pydantic,
    // but images usually require multipart.
    
    // Let's assume we just log it for now as I don't have the exact API spec for image upload.
    // But I will implement a basic fetch.
    
    try {
        // Construct payload
        // Note: This part depends heavily on backend implementation.
        // I'll assume a simple JSON post for now, ignoring images or assuming they are handled elsewhere.
        // If images are needed, we might need to upload them separately and get URLs.
        
        const payload: any = {
            date: formData.get('date'),
            content: formData.get('content'),
            mood: formData.get('mood'),
            weather: formData.get('weather'),
            images: [] // Placeholder
        };

        // TODO: Handle image upload to get URLs, then add to payload.images
        
        const response = await fetch('http://127.0.0.1:8000/api/admin/diaries', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            // Reset form
            form.reset();
            // Reset images
            document.querySelectorAll('.preview-container').forEach(el => el.classList.add('hidden'));
            // Refresh list
            window.dispatchEvent(new CustomEvent('diary-filter-change')); // Reuse this event to refresh list
            alert('Diary entry created!');
        } else {
            alert('Failed to create diary entry');
        }
    } catch (error) {
        console.error(error);
        alert('Error creating entry');
    }
  });
</script>